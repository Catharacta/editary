# Tauri ベース テキストエディタ（垂直タブ／CodeMirror 6）仕様書

## 1. 概要
Windows 11 のメモ帳的なシンプルさを保ちつつ、ファイルタブをウィンドウ左側に垂直表示するエディタ。上部のアドレスバー位置に現在ファイルのフルパスを表示する。エディタコアには CodeMirror 6 を採用し、Tauri（Rust） を用いてローカルファイル操作やファイル監視を担う。v1.2より「ハイブリッドモード」を採用し、フォルダを開くとプロジェクト管理機能が有効になる。

## 2. 目的
- 直感的で軽快なローカルテキスト編集体験を提供する。
- 垂直タブ UI（Edge の垂直タブ風）によるファイル管理を実現する。
- フォルダ単位の作業も可能な「プロジェクトモード」により、開発用途にも対応する。

## 3. 対象プラットフォーム
- 主に Windows 11（将来的に macOS / Linux をサポート可能）

## 4. 技術選定（確定）
- フロントエンド：React（Vite + React）
- エディタコア：CodeMirror 6
- デスクトップフレームワーク：Tauri（Rust）
- 既定エンコーディング：UTF-8（ただし自動検出を実装して非 UTF-8 ファイルにも対応）

## 5. 用語定義
- Tab: UI 上のファイルエントリ（左垂直タブ）
- AddressBar: 上部に表示される現在ファイルのフルパス表示領域
- Dirty: 編集され保存されていない状態
- MRU: 最近使ったファイル（Most Recently Used）
- Project Root: 開いているフォルダのルートパス

## 6. 機能要件

### 6.1 MVP（必須・確定）
- 左垂直タブ
  - ファイル名、拡張子アイコン、保存状態インジケータを表示
  - 選択でエディタに表示、閉じる（✕）が可能
  - 閉じる時は未保存なら必ず保存確認ダイアログを表示
- アドレスバー（上部）
  - 現在のファイルフルパスを表示（表示のみ）
  - クリックで全選択／コピー
  - 右端に「フォルダを開く（Explorer）」ボタン
- CodeMirror 6 エディタ
  - テキスト編集、undo/redo（セッション中のみ）、行番号
  - 検索（Ctrl+F）／置換（Ctrl+H は MVP で基本実装）
  - 行折り返しのオンオフ
  - プレーンテキスト／Markdown のシンタックスハイライト（MVP）
- ファイル I/O（Tauri 側）
  - 新規、開く、上書き保存、名前を付けて保存（Save As）
  - ファイル読み書きは UTF-8 を既定とするが、読み込み時にエンコーディング自動検出を行う（非 UTF-8 は自動選択またはユーザー選択で再読み込み）
  - MRU（最大 20 件）を永続化（JSON 設定ファイルに保存）
- ファイル監視（外部変更検知）
  - 監視スコープ：開いているファイルのみ
  - 外部変更検知時：UI に通知し、ユーザーが「リロード」または「マージ」を選択できる（自動上書きは不可）
- ファイルロックと競合
  - 保存時にファイルの mtime をチェック。差異がある場合は保存前に警告を出し、ユーザー選択を促す
- 未保存（untitled）ファイル
  - 閉じる時に保存確認を表示。クラッシュ復元は将来的に実装（MVP では未実装）
- 大ファイル
  - 閾値：10MB を超えるファイルを「大ファイル」と見なす。読み込み前に警告し、続行の許可を得る。将来的に部分読み込み／仮想レンダリングを導入
- 設定（最小セットを永続化）
  - 永続化する設定：テーマ（Light/Dark）、フォントサイズ、行番号表示
- セキュリティ allowlist（MVP）
  - 必要最小限を許可：fs.readFile / fs.writeFile / shell.open（限定的に）
  - ドキュメントで許可理由を明記

### 6.2 v1.1 機能（実装済み）
- 画面分割 (Split View): 左右のペインで独立した編集が可能。
- 同期編集: 同一ファイルを開いた場合のリアルタイム同期。
- テーマ永続化修正

### 6.3 v1.2 機能（プロジェクト管理 & 検索 & 設定）
- フォルダを開く (Open Folder)
  - フォルダを選択すると「プロジェクトモード」に移行。
- サイドバー拡張
  - **Activity Bar**: 左端に「Explorer」「Search」等のビュー切り替えバーを配置。
  - **ファイルツリー**: フォルダ階層の展開・折りたたみ表示。
- プロジェクト検索 (Advanced)
  - 正規表現、大文字小文字、単語単位、ファイル除外設定に対応。
  - Rust backend (`ignore` + `regex`) による高速検索。
- 設定画面 (Settings Tab)
  - モーダルを廃止し、タブ型の設定画面 (`SettingsView`) を実装。
  - 検索除外パターン等の設定が可能。

### 6.4 将来（拡張）
- LSP 統合（補完、定義ジャンプ）
- Git 統合（差分表示等）
- プラグイン機構（公開 API）

## 7. 非機能要件（確定）
- パフォーマンス：10MB 以下のファイルで快適に動作すること（MVP）。Rustバックエンドを活用した高速検索。
- レスポンシブ：ウィンドウサイズ変更に対応。左タブは折りたたみ可能。
- 国際化：日本語 UI をデフォルト、i18n を想定設計。
- アクセシビリティ：キーボードショートカット（Windows優先）、ツールチップ、十分なコントラスト。

## 8. UI 要件（詳細）
- レイアウト：左カラム（垂直タブ/ツリー/検索） / 上部（アドレスバー x ペイン数） / 中央（エディタ x ペイン数） / 下部（StatusBar）
- サイドバー（拡張）
  - タブ（アイコン）で表示内容を切り替え：
    1. **File List**: 従来のフラットな「開いているファイル一覧」。
    2. **Explorer**: フォルダツリー（プロジェクトモード時のみ有効）。
    3. **Search**: プロジェクト検索フォームと結果。
- AddressBar
  - 各エディタペインの上部に配置。
- ステータスバー
  - プロジェクトルートが表示されている場合はそのパスも表示推奨。

## 9. CodeMirror 6 に関する要件
- 必要な拡張のみ導入（history, search, lineNumbers, fold, highlight, lang-markdown 等）
- 各タブは EditorState を持つ
- テーマ切替（Light/Dark）をサポート
- パフォーマンスに配慮し不要な拡張は遅延ロードする

## 10. Tauri（Rust）側の責務
- ファイル I/O API（open_file, save_file, save_file_as, new_file, **open_folder**, **read_dir**, **search_files**）
- ファイル監視：notify 等で開いているファイルのみ監視、変更イベントをフロントへ送信
- mtime チェック：保存時に競合があれば警告を返す
- Explorer 表示：shell.open を限定的に allow
- 設定永続化：MRU、最小設定を JSON に保存
- エラーハンドリング：ユーザー向け簡潔メッセージ＋詳細ログをログファイルに保存

## 11. フロント ↔ バック API（拡張案）
- フロント → バック（コマンド）
  - open_folder(path: string) -> DirectoryEntry[]
  - read_dir(path: string) -> DirectoryEntry[]
  - search_files(query: string, path: string, options: SearchOptions) -> SearchResult[]

## 12. データモデル（拡張案）
- ProjectState
  - rootPath: string | null
  - expandedFolders: Set<string>
  - searchResults: SearchResult[]

## 13. 受け入れ基準
- フォルダを開くとツリーが表示され、ファイルを開けること。
- プロジェクト検索で正しい結果が得られ、該当行にジャンプできること。
- 従来通り単一ファイルも問題なく開けること（機能後退がないこと）。
