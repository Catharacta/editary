# Tauri ベース テキストエディタ（垂直タブ／CodeMirror 6）仕様書

## 1. 概要
Windows 11 のメモ帳的なシンプルさを保ちつつ、ファイルタブをウィンドウ左側に垂直表示するエディタ。上部のアドレスバー位置に現在ファイルのフルパスを表示する。エディタコアには CodeMirror 6 を採用し、Tauri（Rust） を用いてローカルファイル操作やファイル監視を担う。

## 2. 目的
- 直感的で軽快なローカルテキスト編集体験を提供する。
- 垂直タブ UI（Edge の垂直タブ風）によるファイル管理を実現する。
- CodeMirror 6 による拡張性と性能を両立する。

## 3. 対象プラットフォーム
- 主に Windows 11（将来的に macOS / Linux をサポート可能）

## 4. 技術選定（確定）
- フロントエンド：React（Vite + React）
- エディタコア：CodeMirror 6
- デスクトップフレームワーク：Tauri（Rust）
- 既定エンコーディング：UTF-8（ただし自動検出を実装して非 UTF-8 ファイルにも対応）

## 5. 用語定義
- Tab: UI 上のファイルエントリ（左垂直タブ）
- AddressBar: 上部に表示される現在ファイルのフルパス表示領域
- Dirty: 編集され保存されていない状態
- MRU: 最近使ったファイル（Most Recently Used）

## 6. 機能要件

### 6.1 MVP（必須・確定）
- 左垂直タブ
  - ファイル名、拡張子アイコン、保存状態インジケータを表示
  - 選択でエディタに表示、閉じる（✕）が可能
  - 閉じる時は未保存なら必ず保存確認ダイアログを表示
- アドレスバー（上部）
  - 現在のファイルフルパスを表示（表示のみ）
  - クリックで全選択／コピー
  - 右端に「フォルダを開く（Explorer）」ボタン
  - 将来：編集可能モードやブレッドクラム表示の追加を想定
- CodeMirror 6 エディタ
  - テキスト編集、undo/redo（セッション中のみ）、行番号
  - 検索（Ctrl+F）／置換（Ctrl+H は MVP で基本実装）
  - 行折り返しのオンオフ
  - プレーンテキスト／Markdown のシンタックスハイライト（MVP）
- ファイル I/O（Tauri 側）
  - 新規、開く、上書き保存、名前を付けて保存（Save As）
  - ファイル読み書きは UTF-8 を既定とするが、読み込み時にエンコーディング自動検出を行う（非 UTF-8 は自動選択またはユーザー選択で再読み込み）
  - MRU（最大 20 件）を永続化（JSON 設定ファイルに保存）
- ファイル監視（外部変更検知）
  - 監視スコープ：開いているファイルのみ
  - 外部変更検知時：UI に通知し、ユーザーが「リロード」または「マージ」を選択できる（自動上書きは不可）
- ファイルロックと競合
  - 保存時にファイルの mtime をチェック。差異がある場合は保存前に警告を出し、ユーザー選択を促す
- 未保存（untitled）ファイル
  - 閉じる時に保存確認を表示。クラッシュ復元は将来的に実装（MVP では未実装）
- 大ファイル
  - 閾値：10MB を超えるファイルを「大ファイル」と見なす。読み込み前に警告し、続行の許可を得る。将来的に部分読み込み／仮想レンダリングを導入
- 設定（最小セットを永続化）
  - 永続化する設定：テーマ（Light/Dark）、フォントサイズ、行番号表示
- セキュリティ allowlist（MVP）
  - 必要最小限を許可：fs.readFile / fs.writeFile / shell.open（限定的に）
  - ドキュメントで許可理由を明記

### 6.2 中期（優先度高）
- タブのドラッグ並べ替え
- 右クリックコンテキストメニュー（保存、閉じる、フォルダを開く等）
- タブ固定（ピン）機能
- AddressBar の編集モード（将来）：パスを入力して開く/新規作成（存在しないパスは新規ファイル作成オプション）
- 検索／置換 UI の拡張、テーマ切替 UI

### 6.3 将来（拡張）
- LSP 統合（補完、定義ジャンプ） — 実装方針：Rust 側で LSP プロセスを spawn して IPC で連携
- Git 統合（差分表示等、LSP 対応後の予定）
- プラグイン機構（公開 API）
- 非 UTF-8 サポートの強化（より信頼できる自動検出と保存時エンコーディング指定）
- 大ファイルの部分読み込み・仮想化、自動保存・クラッシュ復元

## 7. 非機能要件（確定）
- パフォーマンス：10MB 以下のファイルで快適に動作すること（MVP）。大ファイルは警告。
- レスポンシブ：ウィンドウサイズ変更に対応。左タブは折りたたみ可能。
- 国際化：日本語 UI をデフォルト、i18n を想定設計。
- アクセシビリティ：キーボードショートカット（Windows優先）、ツールチップ、十分なコントラスト。

## 8. UI 要件（詳細）
- レイアウト：左カラム（垂直タブ） / 上部（AddressBar） / 中央（Editor） / 下部（StatusBar）
- 垂直タブ
  - デフォルト幅（例: 56px）、展開幅を持たせる設計可
  - アイコンは拡張子ベース、保存状態マーク、ツールチップでフルパス表示
- AddressBar
  - 表示専用（MVP）＋全選択コピー＋Explorer 表示ボタン
  - 将来は編集可能にしてパス入力でファイル作成や移動を実施
- ステータスバー
  - 行・列、エンコーディング表示（自動検出結果）、改行コード、ファイルサイズ

## 9. CodeMirror 6 に関する要件
- 必要な拡張のみ導入（history, search, lineNumbers, fold, highlight, lang-markdown 等）
- 各タブは EditorState を持つ（undo/redo はセッション中のみ保持。MVPでは永続化しない）
- テーマ切替（Light/Dark）をサポート
- パフォーマンスに配慮し不要な拡張は遅延ロードする

## 10. Tauri（Rust）側の責務
- ファイル I/O API（open_file, save_file, save_file_as, new_file）
- ファイル監視：notify 等で開いているファイルのみ監視、変更イベントをフロントへ送信
- mtime チェック：保存時に競合があれば警告を返す
- Explorer 表示：shell.open を限定的に allow
- 設定永続化：MRU、最小設定を JSON に保存
- エラーハンドリング：ユーザー向け簡潔メッセージ＋詳細ログをログファイルに保存

## 11. フロント ↔ バック API（確定案）
- フロント → バック（コマンド）
  - open_file(path: string)
  - save_file(path: string, content: string)
  - save_file_as(path: string, content: string)
  - new_file()
  - watch_file(path: string)
  - unwatch_file(path: string)
  - reveal_in_explorer(path: string)
  - get_recent_files()
  - get_file_stat(path: string)
- バック → フロント（イベント）
  - file_opened { path, content, stat }
  - file_saved { path, stat }
  - file_changed_externally { path }
  - file_error { path?, message }

## 12. データモデル（確定案）
- Tab
  - id: string
  - path: string | null (untitled)
  - displayName: string
  - content: string | null (ロード済み)
  - dirty: boolean
  - encoding: string (自動検出結果)
  - lastSavedAt: ISOString | null
  - cursorPos: { line, column } | null
  - scrollPos: number | null
- FileStat
  - path: string
  - size: number
  - mtime: ISOString
  - readonly: boolean

## 13. 受け入れ基準（MVP の DoD：確定）
- 左垂直タブで複数ファイルを開き切替できる
- 上部にファイルパスが表示され、コピーと Explorer 表示が動作する
- CodeMirror 6 で編集ができ、undo/redo（セッション中）・行番号が機能する
- ファイルの開く／保存（上書き／名前を付けて保存）が動作する
- ファイルの外部編集を検知し UI に通知できる（ユーザーがリロード or マージ選択）
- 保存時に mtime 差異があれば警告が出る
- 非 UTF-8 ファイルは自動検出され、必要ならユーザーが別エンコーディングで再読み込み可能
- MRU（最大 20 件）が JSON に永続化される
- Tauri の allowlist は fs.readFile / fs.writeFile / shell.open の必要最小限に限定されている

## 14. テスト計画（確定）
- ユニットテスト
  - ファイル I/O ロジック（読み込み、書き込み、競合検出）
  - Tab ライフサイクルと dirty フラグ
  - 設定永続化（MRU, 小セット）
- E2E テスト（Playwright）
  - 主要ワークフロー自動化：open → edit → save → external change 検知
- 手動チェック
  - 長いパス、アクセス権限エラー、非 UTF-8 ファイルの表示確認
  - 大ファイル（10MB 超）の警告挙動

## 15. 開発ステージと概算工数（目安）
- 設計（本仕様の確定、フォルダ構成決定）：0.5–1 日
- MVP 実装（Tauri + Vite + React + CodeMirror 統合、基本ファイル I/O、垂直タブ、AddressBar、ファイル監視）：5–10 日
- テスト・修正・ドキュメント：2–4 日  
（合計想定：1–3 週間、1 人の開発者、要件の細かさで変動）

## 16. 技術的注意点 / リスク（確定）
- CodeMirror: EditorState はタブ毎に分離する。undo 履歴永続化は MVP では行わないが、拡張しやすい設計にする
- 非 UTF-8: 自動検出は誤検出の可能性あり。ユーザー選択モードを必ず提供する
- 大ファイル: 一律読み込みはパフォーマンス問題につながるため警告と段階的実��を採用
- Tauri allowlist の設定ミスは実行時エラーを招くためドキュメント化と最小権限設定を厳守

## 17. ログ・診断
- ユーザー向けには簡潔なエラーメッセージを表示
- 詳細ログ（デバッグ用）はアプリケーションデータディレクトリにログファイルとして保存
- 重大なエラー発生時はログの保存パスをユーザーに通知（サポート用）

## 18. 拡張性方針（短期）
- 内部的にエディタ拡張ポイントを残し、将来的に言語モードや機能追加を差し替えやすい設計にする
- 公開プラグイン API は MVP 範囲外だが、設計段階で将来的に対応しやすい構造を確保する

